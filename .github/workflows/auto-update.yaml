# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Workflow to update selected repos in r-hyperspec/... with selected files
# from r-hyperspec/pkg-skeleton when pkg-skeleton is updated by pushing.
# pkg-skeleton branch auto-update will deploy to develop branch in other repos.
#
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Each "- name:" task below starts from the same directory, which is:
# /home/runner/work/${{ REPOSITORY_NAME }}/${{ REPOSITORY_NAME }}
# e.g.:
# /home/runner/work/hyperSpec/hyperSpec
# Each task is run in its own shell starting from this directory.
# This means you have to navigate to the desired directory for each task.
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

on:
  push:
    branches:
      - auto-update

name: Update files
# name: Update selected files in selected repos


jobs:
  update:
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.event.repository.name }}
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      FILES: |
        .github/workflows/drat--insert-package.yaml
        .github/workflows/R-CMD-check.yaml
        .github/workflows/pkgdown.yaml
        pkgdown/extra.css
        .gitignore
        .Rbuildignore
        project.Rproj
      FILES_IF_PRESENT: |
        codecov.yml
        .github/workflows/test-coverage.yaml
      VIG_FILES: |
        vignettes/.install_extras
        vignettes/elsevier-with-titles.csl
        vignettes/list-of-vignettes.md
        vignettes/style.css
        vignettes/vignette-default-settings.R
        vignettes/vignette-functions.R
        vignettes/vignette.css
    strategy:
      matrix:
        pkgs:
          - r-hyperspec/hySpc.read.spe
          - r-hyperspec/hySpc.chondro

    steps:
      - uses: actions/checkout@v2 # checks out current repo

      - name: Configure git
        # The following configure step is from
        # https://stackoverflow.com/a/60548651/633251
        env:
          TOKEN: ${{ secrets.DEPLOY_TOKEN }}
        run: |
          git config --global url."https://${TOKEN}:x-oauth-basic@github.com/".insteadOf "https://github.com/"

          git config --global user.email "${REPO}_Deploy_Bot@example.com"
          git config --global user.name "${REPO} Deploy Bot"

      - name: Clone Packages
        if: success()
        run: |
          # echo Cloning ${{ matrix.pkgs }}
          rm -rf tmp-repo-dir
          git clone 'https://github.com/${{ matrix.pkgs }}.git' tmp-repo-dir
          cd tmp-repo-dir
          git checkout develop
          # echo Successfully cloned ${{ matrix.pkgs }}

      - name: Copy Required Non-Vig Files
        if: success()
        run: |
          for f in $FILES
          do
            echo "v Syncing file   $f"
            rsync -Rrtpgov $f tmp-repo-dir/
          done

      - name: Conditionally Copy Optional Non-Vig Files
        if: success()
        run: |
          for f in $FILES_IF_PRESENT
          do
            echo "File $f"
            if [ -f "tmp-repo-dir/$f" ]
            then
              echo "v Syncing file   $f"
              rsync -Rrtpgov $f tmp-repo-dir/
            else
              echo "x Skipping file  $f"
            fi
          done

      - name: Conditionally Copy Vignette Files
        if: success()
        run: |
          if [ -d "tmp-repo-dir/vignettes" ]
          then
            for f in $VIG_FILES
            do
              echo "v Syncing file   $f"
              rsync -Rrtpgov $f tmp-repo-dir/
            done
          fi

      - name: Commit and Push
        if: success()
        run: |
          cd tmp-repo-dir
          if [ -n "$(git status --porcelain)" ]; then
            git status
            git add .
            git commit -m 'Automated file update from pkg-skeleton'
            git push origin develop
          else
            echo "Nothing to commit";
          fi
